version: v1.0
name: BEST Headless Server with LocalTunnel
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
global_job_config:
  prologue:
    commands:
      - checkout
blocks:
  - name: Deploy Backend
    task:
      env_vars:
        - name: HEADLESS
          value: 'true'
        - name: API_PORT
          value: '3000'
        - name: DISPLAY
          value: ':99'
        - name: NODE_VERSION
          value: '20'
        - name: TUNNEL_SUBDOMAIN
          value: best-backend
        - name: DURATION
          value: '60'
      epilogue:
        always:
          commands:
            - echo "Cleaning up..."
            - 'curl -X POST http://localhost:3000/api/disconnect -H "Content-Type: application/json" || true'
            - echo "Cleanup complete"
      jobs:
        - name: Deploy
          commands:
            - sem-version node $NODE_VERSION
            - node --version
            - npm --version
            - cache restore node-modules-$SEMAPHORE_GIT_BRANCH-$(checksum resources/app/package.json)
            - echo "Installing system dependencies..."
            - sudo apt-get update -qq
            - sudo apt-get install -y --no-install-recommends libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libpango-1.0-0 libcairo2 libatspi2.0-0 xvfb libasound2 || true
            - echo "System dependencies installed"
            - cd resources/app
            - npm install --prefer-offline --no-audit
            - echo "Application dependencies installed"
            - cd ../..
            - cache store node-modules-$SEMAPHORE_GIT_BRANCH-$(checksum resources/app/package.json) resources/app/node_modules
            - npm install -g localtunnel --no-audit --silent
            - echo "localtunnel installed"
            - echo "Starting virtual display..."
            - 'Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &'
            - sleep 1
            - echo "Starting BEST in headless mode..."
            - cd resources/app
            - test -f package.json || exit 1
            - test -d node_modules || exit 1
            - test -f main.js || exit 1
            - echo "All required files present"
            - nohup npm run headless > ../../best-server.log 2>&1 &
            - export BEST_PID=$!
            - echo "BEST started with PID $BEST_PID"
            - echo "Waiting for API server..."
            - sleep 3
            - |
              for i in 1 2 3 4 5 6; do
                echo "Attempt $i to connect to API server..."
                if curl -s --max-time 3 http://localhost:3000/api/health > /dev/null 2>&1; then
                  echo "API Server is running"
                  break
                fi
                if [ $i -eq 6 ]; then
                  echo "Failed to start API Server"
                  tail -n 100 ../../best-server.log
                  exit 1
                fi
                sleep 2
              done
            - cd ../..
            - echo "Starting localtunnel with subdomain $TUNNEL_SUBDOMAIN"
            - 'export TUNNEL_URL="https://$TUNNEL_SUBDOMAIN.loca.lt"'
            - nohup lt --port 3000 --subdomain "$TUNNEL_SUBDOMAIN" > localtunnel.log 2>&1 &
            - export LT_PID=$!
            - echo "LocalTunnel started with PID $LT_PID"
            - sleep 3
            - |
              for i in 1 2 3 4 5; do
                if grep -q "your url is:" localtunnel.log 2>/dev/null; then
                  echo "LocalTunnel established"
                  break
                fi
                sleep 2
              done
            - echo "=========================================="
            - echo "LocalTunnel Established"
            - echo "=========================================="
            - echo ""
            - 'echo "Your BEST Backend is accessible at:"'
            - echo "    $TUNNEL_URL"
            - echo ""
            - echo "=========================================="
            - echo ""
            - 'echo "API Endpoints:"'
            - echo "  GET  $TUNNEL_URL/api/health"
            - echo "  GET  $TUNNEL_URL/api/status"
            - echo "  GET  $TUNNEL_URL/api/logs"
            - echo "  POST $TUNNEL_URL/api/configure"
            - echo "  POST $TUNNEL_URL/api/connect"
            - echo "  POST $TUNNEL_URL/api/disconnect"
            - echo "  POST $TUNNEL_URL/api/send"
            - echo ""
            - echo "=========================================="
            - echo ""
            - 'echo "Example - Configure:"'
            - echo 'curl -X POST $TUNNEL_URL/api/configure \'
            - echo '  -H "bypass-tunnel-reminder: true" \'
            - echo '  -H "Content-Type: application/json" \'
            - 'echo ''  -d ''"''"''{"rc1":"CODE","planet":"Earth","device":"312"}''"''"'
            - echo ""
            - 'echo "Example - Connect:"'
            - echo 'curl -X POST $TUNNEL_URL/api/connect \'
            - echo '  -H "bypass-tunnel-reminder: true"'
            - echo ""
            - echo "=========================================="
            - |
              echo ""
              echo "Backend running for $DURATION minutes"
              echo "Started: $(date '+%Y-%m-%d %H:%M:%S')"
              echo ""

              end_time=$((SECONDS + DURATION * 60))
              check_count=0

              while [ $SECONDS -lt $end_time ]; do
                check_count=$((check_count + 1))
                
                if status_response=$(curl -s --max-time 5 http://localhost:3000/api/status 2>/dev/null); then
                  connected=$(echo "$status_response" | grep -o '"connected":[^,}]*' | cut -d':' -f2)
                  remaining=$(( (end_time - SECONDS) / 60 ))
                  
                  if [ "$connected" = "true" ]; then
                    status_icon="Connected"
                  else
                    status_icon="Ready"
                  fi
                  
                  echo "[$(date '+%H:%M:%S')] Check $check_count | $status_icon | Time left: $remaining min"
                  
                  if [ $((check_count % 10)) -eq 0 ]; then
                    echo "Tunnel URL: $TUNNEL_URL"
                  fi
                else
                  echo "[$(date '+%H:%M:%S')] Status check failed"
                fi
                
                sleep 60
              done

              echo ""
              echo "Run duration completed ($DURATION minutes)"
              echo "Shutting down..."
promotions:
  - name: Deploy
    pipeline_file: semaphore.yml
