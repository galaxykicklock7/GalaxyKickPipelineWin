name: BEST Headless Server with LocalTunnel

on:
  workflow_dispatch:
    inputs:
      subdomain:
        description: 'Custom subdomain (e.g., best-backend-xyz for https://best-backend-xyz.loca.lt)'
        required: true
        default: 'best-backend'
        type: string
      rc1:
        description: 'Recovery Code 1'
        required: false
        type: string
      rc2:
        description: 'Recovery Code 2'
        required: false
        type: string
      rc3:
        description: 'Recovery Code 3'
        required: false
        type: string
      rc4:
        description: 'Recovery Code 4'
        required: false
        type: string
      kickrc:
        description: 'Kick Code'
        required: false
        type: string
      planet:
        description: 'Planet Name'
        required: false
        type: string
      device:
        description: 'Device Type (312=Android, 323=iOS, 352=Web)'
        required: false
        default: '312'
        type: string
      duration:
        description: 'Run duration in minutes (max 360 = 6 hours)'
        required: false
        default: '60'
        type: string

jobs:
  run-best-headless:
    runs-on: windows-latest
    timeout-minutes: 360  # Maximum 6 hours
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      - name: Install dependencies
        shell: pwsh
        run: |
          Write-Host "Installing application dependencies..."
          cd resources/app
          npm install
          Write-Host "‚úÖ Application dependencies installed"

      - name: Install localtunnel
        shell: pwsh
        run: |
          Write-Host "Installing localtunnel globally..."
          npm install -g localtunnel
          Write-Host "‚úÖ localtunnel installed"

      - name: Start BEST in Headless Mode
        shell: pwsh
        env:
          HEADLESS: 'true'
          API_PORT: '3000'
        run: |
          Write-Host "Starting BEST in headless mode..."
          cd resources/app
          Start-Process -NoNewWindow -FilePath "npm" -ArgumentList "run", "headless-win"
          Write-Host "Waiting for API server to start..."
          Start-Sleep -Seconds 10
          
          # Verify server is running
          try {
            $health = Invoke-RestMethod -Uri "http://localhost:3000/api/health" -ErrorAction Stop
            Write-Host "‚úÖ BEST API Server is running!"
            Write-Host "Mode: $($health.mode)"
          } catch {
            Write-Host "‚ùå Failed to start BEST API Server"
            Write-Host "Error: $_"
            exit 1
          }

      - name: Start LocalTunnel
        shell: pwsh
        run: |
          Write-Host "Starting localtunnel..."
          
          $subdomain = "${{ github.event.inputs.subdomain }}"
          
          if ($subdomain) {
            Write-Host "Using custom subdomain: $subdomain"
            $tunnelUrl = "https://$subdomain.loca.lt"
            
            # Start localtunnel in background with proper output redirection
            Start-Job -ScriptBlock {
              param($sub)
              & npx localtunnel --port 3000 --subdomain $sub
            } -ArgumentList $subdomain
          } else {
            Write-Host "Using random subdomain"
            $tunnelUrl = "https://random.loca.lt"
            
            Start-Job -ScriptBlock {
              & npx localtunnel --port 3000
            }
          }
          
          Write-Host "Waiting for tunnel to establish..."
          Start-Sleep -Seconds 10
          
          # Verify tunnel is working by testing localhost
          try {
            $localTest = Invoke-RestMethod -Uri "http://localhost:3000/api/health" -ErrorAction Stop
            Write-Host "‚úÖ Local API server responding: $($localTest.status)"
          } catch {
            Write-Host "‚ùå Warning: Local API not responding"
          }
          
          Write-Host "`n=========================================="
          Write-Host "‚úÖ LocalTunnel Established!"
          Write-Host "=========================================="
          Write-Host ""
          Write-Host "üåê Your BEST Backend is now accessible at:"
          Write-Host ""
          Write-Host "    $tunnelUrl"
          Write-Host ""
          Write-Host "=========================================="
          Write-Host ""
          
          if ($subdomain) {
            Write-Host "‚ú® Custom subdomain: $subdomain"
            Write-Host "üìå This URL will be consistent on future runs!"
            Write-Host "   (as long as you use the same subdomain)"
          } else {
            Write-Host "‚ö†Ô∏è  Random subdomain - URL will change on next run"
          }
          
          Write-Host ""
          Write-Host "üìã Share this URL with your users!"
          Write-Host ""
          Write-Host "‚ö†Ô∏è  IMPORTANT: First-time visitors will see a warning page"
          Write-Host "   Click 'Continue' or 'Click to Continue' to access the API"
          Write-Host ""
          Write-Host "=========================================="

      - name: Configure BEST via API
        if: ${{ github.event.inputs.rc1 != '' || github.event.inputs.rc2 != '' || github.event.inputs.rc3 != '' || github.event.inputs.rc4 != '' }}
        shell: pwsh
        run: |
          Write-Host "Configuring BEST..."
          
          $config = @{
            rc1 = "${{ github.event.inputs.rc1 }}"
            rc2 = "${{ github.event.inputs.rc2 }}"
            rc3 = "${{ github.event.inputs.rc3 }}"
            rc4 = "${{ github.event.inputs.rc4 }}"
            kickrc = "${{ github.event.inputs.kickrc }}"
            planet = "${{ github.event.inputs.planet }}"
            device = "${{ github.event.inputs.device }}"
          }
          
          $jsonConfig = $config | ConvertTo-Json
          
          try {
            Invoke-RestMethod -Method POST -Uri "http://localhost:3000/api/configure" -Body $jsonConfig -ContentType "application/json"
            Write-Host "‚úÖ Configuration applied"
          } catch {
            Write-Host "‚ö†Ô∏è  Configuration failed: $_"
          }

      - name: Connect to Game
        if: ${{ github.event.inputs.rc1 != '' || github.event.inputs.rc2 != '' || github.event.inputs.rc3 != '' || github.event.inputs.rc4 != '' }}
        shell: pwsh
        run: |
          Write-Host "Connecting to game server..."
          try {
            Invoke-RestMethod -Method POST -Uri "http://localhost:3000/api/connect" -ContentType "application/json"
            Write-Host "‚úÖ Connection initiated"
            Start-Sleep -Seconds 3
            $status = Invoke-RestMethod -Uri "http://localhost:3000/api/status"
            Write-Host "Connected: $($status.connected)"
          } catch {
            Write-Host "‚ö†Ô∏è  Connection failed: $_"
          }

      - name: Display API Information
        shell: pwsh
        run: |
          $subdomain = "${{ github.event.inputs.subdomain }}"
          
          if ($subdomain) {
            $tunnelUrl = "https://$subdomain.loca.lt"
          } else {
            $tunnelUrl = "https://[random].loca.lt (check logs above)"
          }
          
          Write-Host "`n=========================================="
          Write-Host "üìö API Endpoints"
          Write-Host "=========================================="
          Write-Host ""
          Write-Host "Base URL: $tunnelUrl"
          Write-Host ""
          Write-Host "Available endpoints:"
          Write-Host "  GET  $tunnelUrl/api/health"
          Write-Host "  GET  $tunnelUrl/api/status"
          Write-Host "  GET  $tunnelUrl/api/logs"
          Write-Host "  POST $tunnelUrl/api/configure"
          Write-Host "  POST $tunnelUrl/api/connect"
          Write-Host "  POST $tunnelUrl/api/disconnect"
          Write-Host "  POST $tunnelUrl/api/send"
          Write-Host ""
          Write-Host "=========================================="
          Write-Host ""
          Write-Host "üìù Example: Test with curl"
          Write-Host ""
          Write-Host "curl $tunnelUrl/api/health"
          Write-Host ""
          Write-Host "üìù Example: Configure"
          Write-Host ""
          Write-Host "curl -X POST $tunnelUrl/api/configure \"
          Write-Host "  -H 'Content-Type: application/json' \"
          Write-Host "  -d '{""rc1"":""YourCode"",""planet"":""Earth"",""device"":""312""}'"
          Write-Host ""
          Write-Host "=========================================="
          Write-Host ""
          Write-Host "üí° TIP: Save your subdomain for consistent URLs!"
          Write-Host "   Subdomain used: $subdomain"
          Write-Host ""

      - name: Keep Running
        shell: pwsh
        run: |
          $duration = [int]"${{ github.event.inputs.duration }}"
          if ($duration -gt 360) { $duration = 360 }  # Max 6 hours
          if ($duration -lt 1) { $duration = 60 }     # Default 1 hour
          
          $subdomain = "${{ github.event.inputs.subdomain }}"
          $tunnelUrl = if ($subdomain) { "https://$subdomain.loca.lt" } else { "https://[random].loca.lt" }
          
          Write-Host "`n=========================================="
          Write-Host "üöÄ Backend is Running!"
          Write-Host "=========================================="
          Write-Host ""
          Write-Host "Tunnel URL: $tunnelUrl"
          Write-Host "Duration: $duration minutes"
          Write-Host "Started: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Write-Host "Will stop: $((Get-Date).AddMinutes($duration).ToString('yyyy-MM-dd HH:mm:ss'))"
          Write-Host ""
          Write-Host "Monitoring status every 60 seconds..."
          Write-Host ""
          
          $endTime = (Get-Date).AddMinutes($duration)
          $checkCount = 0
          
          while ((Get-Date) -lt $endTime) {
            $checkCount++
            try {
              $status = Invoke-RestMethod -Uri "http://localhost:3000/api/status" -ErrorAction SilentlyContinue
              $remaining = [math]::Round((($endTime - (Get-Date)).TotalMinutes), 1)
              
              $connectedStatus = if ($status.connected) { "‚úÖ Connected" } else { "‚≠ï Disconnected" }
              $activeWS = @($status.websockets.PSObject.Properties | Where-Object { $_.Value -eq $true }).Count
              
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Check #$checkCount | $connectedStatus | Active WS: $activeWS | Time left: $remaining min"
              
              # Show tunnel URL reminder every 10 checks
              if ($checkCount % 10 -eq 0) {
                Write-Host ""
                Write-Host "üìå Reminder - Your tunnel URL: $tunnelUrl"
                Write-Host ""
              }
            } catch {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚ö†Ô∏è  Server status check failed"
            }
            Start-Sleep -Seconds 60
          }
          
          Write-Host "`n=========================================="
          Write-Host "‚è∞ Run duration completed ($duration minutes)"
          Write-Host "=========================================="
          Write-Host "Shutting down gracefully..."

      - name: Cleanup
        if: always()
        shell: pwsh
        run: |
          Write-Host "Cleaning up..."
          
          # Disconnect WebSockets
          try {
            Invoke-RestMethod -Method POST -Uri "http://localhost:3000/api/disconnect" -ContentType "application/json" -ErrorAction SilentlyContinue
            Write-Host "‚úÖ WebSockets disconnected"
          } catch {
            Write-Host "Disconnect request skipped (server may be stopped)"
          }
          
          Write-Host "‚úÖ Cleanup complete"
          Write-Host ""
          Write-Host "Thank you for using BEST Backend! üéâ"
