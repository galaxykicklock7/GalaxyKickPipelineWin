name: BEST Headless Server with LocalTunnel + VPN (Linux)

# This workflow routes all traffic through a Russian VPN server
# WARNING: Using VPN on GitHub Actions may violate their Terms of Service
# Use at your own risk!

on:
  workflow_dispatch:
    inputs:
      subdomain:
        description: 'Custom subdomain (e.g., bharanitest007 for https://bharanitest007.loca.lt)'
        required: true
        type: string
      rc1:
        description: 'Recovery Code 1'
        required: false
        type: string
      rc2:
        description: 'Recovery Code 2'
        required: false
        type: string
      rc3:
        description: 'Recovery Code 3'
        required: false
        type: string
      rc4:
        description: 'Recovery Code 4'
        required: false
        type: string
      kickrc:
        description: 'Kick Code'
        required: false
        type: string
      planet:
        description: 'Planet Name'
        required: false
        type: string
      device:
        description: 'Device Type (312=Android, 323=iOS, 352=Web)'
        required: false
        default: '312'
        type: string
      duration:
        description: 'Run duration in minutes (max 60 = 1 hour)'
        required: false
        default: '60'
        type: string

jobs:
  deploy-backend-vpn:
    name: ðŸš€ Deploy with VPN for ${{ github.event.inputs.subdomain }}
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: resources/app/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('resources/app/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install VPN and system dependencies
        run: |
          echo "=========================================="
          echo "Installing OpenVPN and dependencies..."
          echo "=========================================="
          
          # Update package list
          sudo apt-get update -qq
          
          # Install OpenVPN first (critical)
          echo "Installing OpenVPN..."
          sudo apt-get install -y openvpn
          
          # Verify OpenVPN installed
          if ! command -v openvpn &> /dev/null; then
            echo "âŒ OpenVPN installation failed!"
            exit 1
          fi
          
          openvpn_version=$(openvpn --version | head -n 1)
          echo "âœ… OpenVPN installed: $openvpn_version"
          
          # Install other dependencies
          echo ""
          echo "Installing system dependencies..."
          sudo apt-get install -y --no-install-recommends \
            curl \
            jq \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libpango-1.0-0 \
            libcairo2 \
            libatspi2.0-0 \
            xvfb \
            libasound2 || true
          
          echo "âœ… All dependencies installed"
          echo "=========================================="

      - name: Download and Connect to Russian VPN
        run: |
          echo "=========================================="
          echo "ðŸ”’ Connecting to Russian VPN Server"
          echo "=========================================="
          echo ""
          
          # Create VPN directory
          mkdir -p /tmp/vpn
          cd /tmp/vpn
          
          echo "Fetching VPNGate server list..."
          
          # Download VPNGate CSV (contains free VPN servers worldwide)
          if ! curl -s --max-time 30 "http://www.vpngate.net/api/iphone/" > vpngate.csv; then
            echo "âŒ Failed to download VPNGate server list"
            echo "VPN_CONNECTED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # Verify CSV downloaded
          if [ ! -s vpngate.csv ]; then
            echo "âŒ Empty server list"
            echo "VPN_CONNECTED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # Skip CSV header lines (lines starting with * or #)
          echo "Finding best Russian VPN server..."
          
          # Parse CSV and find Russian servers (skip header lines with *)
          russian_servers=$(cat vpngate.csv | grep -v "^\*" | grep -v "^#" | grep ",RU," 2>/dev/null | head -n 10)
          
          if [ -z "$russian_servers" ]; then
            echo "âš ï¸  No Russian servers found, trying nearby countries..."
            # Try Finland, Estonia, Latvia (close to Russia)
            russian_servers=$(cat vpngate.csv | grep -v "^\*" | grep -v "^#" | grep -E ",FI,|,EE,|,LV," 2>/dev/null | head -n 10)
          fi
          
          if [ -z "$russian_servers" ]; then
            echo "âŒ No suitable VPN servers found"
            echo "Continuing without VPN..."
            echo "VPN_CONNECTED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # Get the fastest server (first one after sorting by speed)
          best_server=$(echo "$russian_servers" | head -n 1)
          
          # VPNGate CSV format (skip first 2 header lines):
          # Column 1: HostName
          # Column 7: CountryLong
          # Column 15: OpenVPN_ConfigData_Base64
          
          server_name=$(echo "$best_server" | awk -F',' '{print $1}')
          server_country=$(echo "$best_server" | awk -F',' '{print $7}')
          server_ip=$(echo "$best_server" | awk -F',' '{print $2}')
          
          echo ""
          echo "Selected VPN Server:"
          echo "  Name: $server_name"
          echo "  Country: $server_country"
          echo "  IP: $server_ip"
          echo ""
          
          # Extract base64 config (last field, handle commas in config)
          # Get everything after the 14th comma
          ovpn_base64=$(echo "$best_server" | awk -F',' '{print $15}')
          
          # Verify base64 data exists
          if [ -z "$ovpn_base64" ] || [ "$ovpn_base64" = " " ]; then
            echo "âŒ No OpenVPN config found in CSV"
            echo "VPN_CONNECTED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "Decoding OpenVPN config..."
          
          # Decode and save OpenVPN config (remove any whitespace first)
          echo "$ovpn_base64" | tr -d '[:space:]' | base64 -d > vpn.ovpn 2>/dev/null
          
          # Verify config file
          if [ ! -s vpn.ovpn ]; then
            echo "âŒ Failed to decode VPN config from CSV"
            echo "Trying alternative download method..."
            
            # Alternative Method: Use VPNGate web API to get config directly
            # Try to get UDP config first, then TCP
            echo "Downloading config via web API..."
            
            # Extract session ID from hostname
            session_id=$(echo "$server_name" | sed 's/vpn//')
            
            # Try downloading UDP config
            if curl -s --max-time 20 "http://www.vpngate.net/common/openvpn_download.aspx?sid=$session_id&udp=1" > vpn.ovpn 2>/dev/null; then
              if grep -q "client" vpn.ovpn 2>/dev/null; then
                echo "âœ… Downloaded UDP config"
              else
                # Try TCP config
                curl -s --max-time 20 "http://www.vpngate.net/common/openvpn_download.aspx?sid=$session_id&tcp=1" > vpn.ovpn 2>/dev/null
                if grep -q "client" vpn.ovpn 2>/dev/null; then
                  echo "âœ… Downloaded TCP config"
                fi
              fi
            fi
            
            # Final check
            if [ ! -s vpn.ovpn ] || ! grep -q "client" vpn.ovpn 2>/dev/null; then
              echo "âŒ All download methods failed"
              echo "Trying next server..."
              
              # Try second server from list
              best_server=$(echo "$russian_servers" | sed -n '2p')
              if [ -n "$best_server" ]; then
                server_name=$(echo "$best_server" | awk -F',' '{print $1}')
                session_id=$(echo "$server_name" | sed 's/vpn//')
                
                echo "Trying alternate server: $server_name"
                curl -s --max-time 20 "http://www.vpngate.net/common/openvpn_download.aspx?sid=$session_id&udp=1" > vpn.ovpn 2>/dev/null
                
                if [ ! -s vpn.ovpn ] || ! grep -q "client" vpn.ovpn 2>/dev/null; then
                  echo "âŒ Failed to download any working VPN config"
                  echo "VPN_CONNECTED=false" >> $GITHUB_ENV
                  exit 0
                fi
              else
                echo "âŒ No alternate servers available"
                echo "VPN_CONNECTED=false" >> $GITHUB_ENV
                exit 0
              fi
            fi
          fi
          
          # Verify it's a valid OpenVPN config
          if ! grep -q "client" vpn.ovpn; then
            echo "âŒ Invalid OpenVPN config file"
            echo "VPN_CONNECTED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "âœ… VPN config ready"
          echo ""
          
          # Show first few lines of config (for debugging)
          echo "Config preview:"
          head -n 5 vpn.ovpn
          echo "..."
          echo ""
          
          echo "Connecting to VPN..."
          
          # Verify OpenVPN is installed
          if ! command -v openvpn &> /dev/null; then
            echo "âŒ OpenVPN not found! Installation may have failed."
            echo "VPN_CONNECTED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # Add connection settings to config for better reliability
          echo "" >> vpn.ovpn
          echo "# Auto-added settings for GitHub Actions" >> vpn.ovpn
          echo "connect-timeout 15" >> vpn.ovpn
          echo "connect-retry-max 3" >> vpn.ovpn
          echo "resolv-retry 10" >> vpn.ovpn
          echo "auth-nocache" >> vpn.ovpn
          
          # Start OpenVPN in background with verbose logging
          echo "Starting OpenVPN daemon..."
          sudo openvpn --config vpn.ovpn --daemon --log /tmp/vpn/openvpn.log --verb 3
          
          if [ $? -ne 0 ]; then
            echo "âŒ Failed to start OpenVPN"
            echo "VPN_CONNECTED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "âœ… OpenVPN daemon started"
          
          # Wait for VPN connection (check every 2 seconds, max 30 seconds)
          echo "Waiting for VPN connection..."
          attempts=0
          max_attempts=15
          vpn_connected=false
          
          while [ $attempts -lt $max_attempts ]; do
            attempts=$((attempts + 1))
            sleep 2
            
            # Check if tun0 interface exists (VPN connected)
            if ip addr show tun0 > /dev/null 2>&1; then
              echo "âœ… VPN connected!"
              vpn_connected=true
              break
            fi
            
            echo "Attempt $attempts/$max_attempts..."
          done
          
          if [ "$vpn_connected" = "false" ]; then
            echo "âŒ VPN connection failed"
            echo ""
            echo "OpenVPN logs:"
            cat /tmp/vpn/openvpn.log || echo "No logs available"
            echo ""
            echo "Continuing without VPN..."
            echo "VPN_CONNECTED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # Verify external IP changed
          echo ""
          echo "Verifying VPN connection..."
          sleep 3
          
          external_ip=$(curl -s --max-time 10 https://api.ipify.org)
          ip_info=$(curl -s --max-time 10 "https://ipapi.co/$external_ip/json/")
          
          country=$(echo "$ip_info" | jq -r '.country_name // "Unknown"')
          city=$(echo "$ip_info" | jq -r '.city // "Unknown"')
          
          echo ""
          echo "=========================================="
          echo "âœ… VPN Connection Established!"
          echo "=========================================="
          echo ""
          echo "External IP: $external_ip"
          echo "Location: $city, $country"
          echo ""
          echo "All traffic will now route through VPN"
          echo "=========================================="
          echo ""
          
          echo "VPN_CONNECTED=true" >> $GITHUB_ENV
          echo "VPN_IP=$external_ip" >> $GITHUB_ENV
          echo "VPN_COUNTRY=$country" >> $GITHUB_ENV

      - name: Install application dependencies
        run: |
          cd resources/app
          npm install --prefer-offline --no-audit
          echo "âœ… Application dependencies installed"

      - name: Install localtunnel
        run: |
          npm install -g localtunnel --no-audit --silent
          echo "âœ… localtunnel installed globally"

      - name: Start BEST in Headless Mode
        env:
          HEADLESS: 'true'
          API_PORT: '3000'
          DISPLAY: ':99'
          TUNNEL_SUBDOMAIN: '${{ github.event.inputs.subdomain }}'
        run: |
          echo "Starting virtual display (Xvfb)..."
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          sleep 1
          echo "âœ… Virtual display started"

          echo "Starting BEST in headless mode..."
          cd resources/app

          # Verify files exist
          if [ ! -f "package.json" ]; then
            echo "âŒ package.json not found!"
            exit 1
          fi

          if [ ! -d "node_modules" ]; then
            echo "âŒ node_modules not found!"
            exit 1
          fi

          if [ ! -f "main.js" ]; then
            echo "âŒ main.js not found!"
            exit 1
          fi

          echo "âœ… All required files present"

          # Start BEST in background
          echo "ðŸš€ Starting BEST with HEADLESS=true"
          nohup npm run headless > ../../best-server.log 2>&1 &
          BEST_PID=$!
          echo "âœ… BEST started with PID: $BEST_PID"

          # Wait for server to start
          echo "Waiting for API server to start..."
          sleep 3

          # Verify server is running
          attempts=0
          max_attempts=6
          server_started=false
          wait_time=2

          while [ $attempts -lt $max_attempts ] && [ "$server_started" = "false" ]; do
            attempts=$((attempts + 1))
            echo "Attempt $attempts/$max_attempts to connect to API server..."

            if curl -s --max-time 3 http://localhost:3000/api/health > /dev/null 2>&1; then
              health_response=$(curl -s http://localhost:3000/api/health)
              echo "âœ… BEST API Server is running!"
              echo "Response: $health_response"
              server_started=true
            else
              echo "âš ï¸  Attempt $attempts failed"
              if [ $attempts -lt $max_attempts ]; then
                echo "Waiting $wait_time seconds before retry..."
                sleep $wait_time
                wait_time=$((wait_time * 2))
              fi
            fi
          done

          if [ "$server_started" = "false" ]; then
            echo "âŒ Failed to start BEST API Server"
            echo ""
            echo "Server logs:"
            tail -n 100 ../../best-server.log || echo "No logs"
            exit 1
          fi

          echo "BEST_PID=$BEST_PID" >> $GITHUB_ENV

      - name: Start LocalTunnel (Routes through VPN)
        run: |
          echo "Starting localtunnel..."
          subdomain="${{ github.event.inputs.subdomain }}"

          if [ -n "$subdomain" ]; then
            echo "Using custom subdomain: $subdomain"
            tunnel_url="https://$subdomain.loca.lt"

            # Start localtunnel in background
            # All tunnel traffic will automatically route through VPN
            nohup lt --port 3000 --subdomain "$subdomain" > localtunnel.log 2>&1 &
            LT_PID=$!
            echo "LocalTunnel started with PID: $LT_PID"
          else
            echo "âŒ Subdomain is required!"
            exit 1
          fi

          echo "Waiting for tunnel to establish..."
          sleep 3

          # Verify tunnel
          attempts=0
          max_attempts=5
          tunnel_established=false

          while [ $attempts -lt $max_attempts ] && [ "$tunnel_established" = "false" ]; do
            attempts=$((attempts + 1))

            if grep -q "your url is:" localtunnel.log 2>/dev/null; then
              echo "âœ… LocalTunnel tunnel established!"
              tunnel_established=true
            else
              if [ $attempts -lt $max_attempts ]; then
                echo "Waiting for tunnel... (attempt $attempts/$max_attempts)"
                sleep 2
              fi
            fi
          done

          echo ""
          echo "=========================================="
          echo "âœ… LocalTunnel Established (via VPN)!"
          echo "=========================================="
          echo ""
          echo "ðŸŒ Your BEST Backend URL:"
          echo ""
          echo "    $tunnel_url"
          echo ""
          
          if [ "${{ env.VPN_CONNECTED }}" = "true" ]; then
            echo "ðŸ”’ VPN Status: CONNECTED"
            echo "ðŸ“ VPN Location: ${{ env.VPN_COUNTRY }}"
            echo "ðŸŒ VPN IP: ${{ env.VPN_IP }}"
            echo ""
            echo "âœ… All game server connections will route through VPN"
          else
            echo "âš ï¸  VPN Status: NOT CONNECTED"
            echo "   (Using direct connection)"
          fi
          
          echo ""
          echo "=========================================="

          echo "LT_PID=$LT_PID" >> $GITHUB_ENV
          echo "TUNNEL_URL=$tunnel_url" >> $GITHUB_ENV

      - name: Configure BEST via API
        if: ${{ github.event.inputs.rc1 != '' || github.event.inputs.rc2 != '' || github.event.inputs.rc3 != '' || github.event.inputs.rc4 != '' }}
        run: |
          echo "Configuring BEST..."
          
          config_json=$(cat <<EOF
          {
            "rc1": "${{ github.event.inputs.rc1 }}",
            "rc2": "${{ github.event.inputs.rc2 }}",
            "rc3": "${{ github.event.inputs.rc3 }}",
            "rc4": "${{ github.event.inputs.rc4 }}",
            "kickrc": "${{ github.event.inputs.kickrc }}",
            "planet": "${{ github.event.inputs.planet }}",
            "device": "${{ github.event.inputs.device }}"
          }
          EOF
          )
          
          if curl -X POST http://localhost:3000/api/configure \
            -H "Content-Type: application/json" \
            -d "$config_json" > /dev/null 2>&1; then
            echo "âœ… Configuration applied"
          else
            echo "âš ï¸  Configuration failed"
          fi

      - name: Connect to Game
        if: ${{ github.event.inputs.rc1 != '' || github.event.inputs.rc2 != '' || github.event.inputs.rc3 != '' || github.event.inputs.rc4 != '' }}
        run: |
          echo "Connecting to game server (via VPN)..."
          
          if curl -X POST http://localhost:3000/api/connect \
            -H "Content-Type: application/json" > /dev/null 2>&1; then
            echo "âœ… Connection initiated"
            sleep 3
            echo "âœ… Connection status verified"
          else
            echo "âš ï¸  Connection failed"
          fi

      - name: Display API Information
        run: |
          tunnel_url="${TUNNEL_URL}"
          subdomain="${{ github.event.inputs.subdomain }}"
          
          echo ""
          echo "=========================================="
          echo "ðŸ“š API Endpoints"
          echo "=========================================="
          echo ""
          echo "Base URL: $tunnel_url"
          echo ""
          echo "Available endpoints:"
          echo "  GET  $tunnel_url/api/health"
          echo "  GET  $tunnel_url/api/status"
          echo "  GET  $tunnel_url/api/logs"
          echo "  POST $tunnel_url/api/configure"
          echo "  POST $tunnel_url/api/connect"
          echo "  POST $tunnel_url/api/disconnect"
          echo "  POST $tunnel_url/api/send"
          echo ""
          echo "=========================================="

      - name: Keep Running with VPN Monitoring
        run: |
          duration="${{ github.event.inputs.duration }}"
          
          # Validate duration
          if [ -z "$duration" ] || [ "$duration" -lt 1 ]; then
            duration=60
          fi
          
          if [ "$duration" -gt 60 ]; then
            duration=60
          fi
          
          subdomain="${{ github.event.inputs.subdomain }}"
          tunnel_url="${TUNNEL_URL}"
          
          echo ""
          echo "=========================================="
          echo "ðŸš€ Backend Running with VPN for $subdomain"
          echo "=========================================="
          echo ""
          echo "Tunnel URL: $tunnel_url"
          echo "Duration: $duration minutes"
          echo "Started: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "Will stop: $(date -d "+$duration minutes" '+%Y-%m-%d %H:%M:%S')"
          
          if [ "${{ env.VPN_CONNECTED }}" = "true" ]; then
            echo "VPN: Connected (${{ env.VPN_COUNTRY }})"
          else
            echo "VPN: Not connected"
          fi
          
          echo ""
          echo "Monitoring status every 60 seconds..."
          echo ""
          
          end_time=$((SECONDS + duration * 60))
          check_count=0
          
          while [ $SECONDS -lt $end_time ]; do
            check_count=$((check_count + 1))
            
            # Check VPN status
            vpn_status="N/A"
            if [ "${{ env.VPN_CONNECTED }}" = "true" ]; then
              if ip addr show tun0 > /dev/null 2>&1; then
                vpn_status="âœ… Connected"
              else
                vpn_status="âŒ Disconnected"
                echo ""
                echo "âš ï¸  WARNING: VPN connection lost!"
                echo "   Attempting to continue..."
                echo ""
              fi
            fi
            
            # Check server status
            if status_response=$(curl -s --max-time 5 http://localhost:3000/api/status 2>/dev/null); then
              connected=$(echo "$status_response" | grep -o '"connected":[^,}]*' | cut -d':' -f2)
              remaining=$(( (end_time - SECONDS) / 60 ))
              
              if [ "$connected" = "true" ]; then
                status_icon="âœ… Connected"
              else
                status_icon="â­• Ready"
              fi
              
              echo "[$(date '+%H:%M:%S')] Check #$check_count | $status_icon | VPN: $vpn_status | Time left: $remaining min"
              
              if [ $((check_count % 10)) -eq 0 ]; then
                echo ""
                echo "ðŸ“Œ Tunnel: $tunnel_url"
                echo ""
              fi
            else
              echo "[$(date '+%H:%M:%S')] âš ï¸  Server status check failed"
            fi
            
            sleep 60
          done
          
          echo ""
          echo "=========================================="
          echo "â° Run duration completed ($duration minutes)"
          echo "=========================================="

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up..."
          
          # Disconnect from game
          curl -X POST http://localhost:3000/api/disconnect \
            -H "Content-Type: application/json" > /dev/null 2>&1 || true
          
          # Stop VPN
          if [ "${{ env.VPN_CONNECTED }}" = "true" ]; then
            echo "Disconnecting VPN..."
            sudo killall openvpn || true
            sleep 2
            echo "âœ… VPN disconnected"
          fi
          
          # Show final logs
          echo ""
          echo "Final server logs:"
          if [ -f "best-server.log" ]; then
            tail -n 50 best-server.log
          fi
          
          echo ""
          echo "âœ… Cleanup complete"
