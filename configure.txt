CONFIGURATION AUDIT REPORT
==========================
Date: 2026-01-14

ISSUE IDENTIFIED:
-----------------
The /api/configure endpoint was filtering out 'kickrc' because it starts with 'rc', 
which was being caught by the old logic: key.startsWith('rc')

Frontend reports sending: kickmode: true, kickall: true
Backend was not executing kick actions

FIXES APPLIED:
--------------

1. appState.js - Added missing config fields:
   ‚úÖ imprisonmode: false
   ‚úÖ kickrc: ""

2. main.js - Fixed /api/configure endpoint logic:
   ‚úÖ Changed from key.startsWith('rc') to precise regex matching
   ‚úÖ Now uses /^rc[1-5]$/ and /^rcl[1-5]$/ to only filter recovery codes
   ‚úÖ Added explicit handling for kickrc field
   ‚úÖ All other settings now update properly
   ‚úÖ Added debug logging to show received config and updated kick settings

3. gameLogic.js - Added comprehensive debug logging:
   ‚úÖ handle353Message now logs config state and routing decision
   ‚úÖ handleJoinMessage now logs config state and routing decision
   ‚úÖ Shows which handler is being called (Kick/Imprison, Normal, BAN, Low Sec)

DEBUGGING STEPS:
----------------

1. Start the backend server:
   cd resources/app
   node main.js --headless

2. In another terminal, test the configuration:
   node test-config.js

3. Send configuration from frontend and watch the logs for:
   [API] /api/configure received: {...}
   [API] Updated config - Kick settings: {...}

4. When a 353 or JOIN message arrives, watch for:
   [WS1] 353 - Config check: {kickmode: true, kickall: true, ...}
   [WS1] 353 - kickModeEnabled: true
   [WS1] 353 - Routing to Kick/Imprison mode

5. Inside handle353KickMode, watch for:
   [WS1] 353 Kick mode - Processing user list
   [WS1] 353 Kick mode options - Everyone=true, ByBlacklist=false, Dad+=false

EXPECTED BEHAVIOR:
------------------

When kickmode=true and kickall=true:
1. Config endpoint receives and saves both flags
2. handle353Message detects kickModeEnabled=true
3. Routes to handle353KickMode
4. handle353KickMode processes with "Everyone" mode
5. Sends KICK commands for all users on planet

When kickmode=false and imprisonmode=true and kickall=true:
1. Config endpoint receives and saves both flags
2. handle353Message detects kickModeEnabled=true
3. Routes to handle353KickMode
4. handle353KickMode processes with "Everyone" mode in imprison mode
5. Sends ATTACK commands for all users on planet

CONFIGURATION FIELDS STATUS:
----------------------------

Recovery Codes (handled separately):
‚úÖ rc1, rc2, rc3, rc4, rc5
‚úÖ rcl1, rcl2, rcl3, rcl4, rcl5

Special Fields:
‚úÖ kickrc - NOW WORKING (was being filtered out)
‚úÖ planet
‚úÖ device

Feature Flags:
‚úÖ autorelease - Working (used in gameLogic.js for prison escape)
‚úÖ smart - Working
‚úÖ lowsecmode - Working
‚úÖ exitting - Working
‚úÖ sleeping - Working
‚úÖ kickmode - Working (determines kick vs imprison)
‚úÖ imprisonmode - NOW WORKING (just added to config)
‚úÖ modena - Working
‚úÖ kickbybl - Working
‚úÖ dadplus - Working
‚úÖ kickall - Working (everyone mode)
‚úÖ timershift - Working
‚úÖ rotateRC - Working
‚úÖ roundRobin - Working

Blacklists (all working properly):
‚úÖ blacklist - Used for imprison mode username filtering
‚úÖ gangblacklist - Used for imprison mode gang filtering
‚úÖ kblacklist - Used for kick mode username filtering
‚úÖ kgangblacklist - Used for kick mode gang filtering

Timing Settings:
‚úÖ attack1-5 (1940ms default)
‚úÖ waiting1-5 (1910ms default)
‚úÖ incrementvalue (10)
‚úÖ decrementvalue (10)
‚úÖ minatk (1000)
‚úÖ maxatk (3000)
‚úÖ mindef (1000)
‚úÖ maxdef (3000)
‚úÖ reconnect (5000)

Deprecated/Ignored:
‚ö†Ô∏è aiMode - Sent by frontend but REMOVED from backend (intentional)

TROUBLESHOOTING:
----------------

If kick mode still doesn't work after these fixes:

1. Check if connections are established:
   - Look for "‚úÖ Connection established" in logs
   - Verify websockets are in OPEN state

2. Check if 353 messages are being received:
   - Look for "[WS1] RAW MESSAGE: 353..." in logs
   - Verify the message contains user list

3. Check config propagation:
   - Verify "[API] Updated config - Kick settings" shows kickall: true
   - Verify "[WS1] 353 - Config check" shows kickall: true
   - If config shows false, the frontend request didn't reach backend

4. Check routing logic:
   - Verify "[WS1] 353 - kickModeEnabled: true" appears
   - Verify "[WS1] 353 - Routing to Kick/Imprison mode" appears
   - If routing to wrong handler, check config values

5. Check kick execution:
   - Look for "[WS1] 353 Kick mode - Everyone mode active"
   - Look for "üë¢ Kicking" messages in logs
   - Look for "KICK <userid>" being sent

VERIFICATION:
-------------
All configuration fields from the frontend curl command are now properly:
1. Defined in appState.config
2. Updated by /api/configure endpoint
3. Used by gameLogic.js where applicable
4. Logged for debugging

The kickall + kickmode combination will now work correctly!

